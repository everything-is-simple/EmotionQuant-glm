# 监控与告警设计

**版本**: v0.3
**最后更新**: 2026-02-09
**状态**: 可执行草案（Spiral Lite）

## 目标

- 定义监控指标范围与告警级别
- 覆盖数据质量与运行稳定性检查

## 监控范围

- 数据层：`raw_*`、`stock_info`、`trade_calendar` 的完整性与时效
- 因子层：MSS / IRS / PAS 输出覆盖率、异常值比例、耗时
- Validation 层：Gate 决策状态（PASS/WARN/FAIL）、因子 IC 偏离、权重验证失败、`stale_days` 超阈值
- 集成层：Integration 成功率、推荐数量、边界校验失败数
- 交易层：下单成功率、拒单原因分布、T+1 限制触发数
- 系统层：任务耗时、失败率、重试次数、队列积压

## 关键指标与阈值

- 数据完整性/时效性/范围
- 任务执行时延
- 失败率与重试率

| 类别 | 指标 | 阈值 | 级别 |
|------|------|------|------|
| 数据时效 | 当日 `trade_calendar` 未就绪 | > 5 分钟 | P1 |
| 数据完整 | `stock_info` 覆盖率 | < 99% | P1 |
| 算法输出 | MSS/IRS/PAS 产出为空 | 任一为空 | P1 |
| Validation Gate | `final_gate=FAIL` | 1 次即触发 | P0 |
| Validation 过期 | `stale_days > 3` | > 3 天 | P1 |
| 因子验证 | `mean_ic < 0` | 任一因子失效 | P1 |
| 集成质量 | `final_score` 越界数（`< 0` 或 `> 100`） | > 0 | P0 |
| 交易执行 | 下单失败率（5分钟窗口） | > 10% | P1 |
| 稳定性 | 单任务连续失败 | ≥ 3 次 | P1 |
| 稳定性 | 关键任务中断 | 1 次即触发 | P0 |

## 告警级别与升级路径

- P0（阻断）：交易链路不可用/核心数据缺失/评分越界；立即通知并停止下游任务。
- P1（高优先）：关键任务持续失败/覆盖率明显下降；通知负责人并触发自动重试。
- P2（一般）：轻微抖动与单次失败；记录并在日报汇总。

升级规则：
- 同一任务 30 分钟内 `P1` 连续触发 3 次 → 升级为 `P0`
- `P2` 连续 10 次未恢复 → 升级为 `P1`

通知路径：
- P0：控制台 + 日志 + 即时消息（主通道）
- P1：控制台 + 日志 + 即时消息（次通道）
- P2：控制台 + 日志（日报汇总）

## 失败重试策略（与调度器联动）

- 重试算法：指数退避 `delay = min(base * 2^n, max_delay)`
- 默认参数：`base=30s`，`max_delay=480s（8min）`，`max_retries=5`
- 幂等要求：重试前必须校验任务幂等键（`trade_date + module + run_id`）
- 熔断策略：达到 `max_retries` 后置为失败并上报告警，不无限重试

## 约束

- 不违反系统铁律
- 路径硬编码绝对禁止

---

## 变更记录

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v0.3 | 2026-02-09 | 修复 R25：监控范围补齐 Validation Layer；新增 Validation 关键指标与阈值；明确 `final_score` 越界定义；重试参数与调度器统一为 `max_delay=480s` |
| v0.2 | 2026-02-08 | 修复 R10：补齐监控范围、阈值、告警升级路径与重试策略（指数退避） |
| v0.1 | 2026-02-02 | 初始占位草案 |
